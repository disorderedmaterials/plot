parameters:
  - name: qtver
    default: 6.2.2

steps:
  - bash: |
      pip3 install dmgbuild biplist
      wget https://raw.githubusercontent.com/disorderedmaterials/scripts/master/prep-dmg
      chmod u+x ./prep-dmg
    displayName: 'Install Prerequisites'
  - bash: |
      set -ex
      Qt6_ROOT=/tmp/qt/${{ parameters.qtver }}/macos/
      # Get program version
      MILDRED_VERSION=`grep "#define MILDREDVERSION" src/version.h | sed "s/.*\"\(.*\)\"/\1/g"`
      ls -R build/
      ./prep-dmg -a Mildred -v ${MILDRED_VERSION} -b build/bin/mildred.app/Contents/MacOS/mildred -d ${Qt6_ROOT} -p build/bin/mildred.app/Contents/Info.plist
    displayName: 'Prepare DMG Dirs'
  - bash: |
      set -ex
      # Get program version
      MILDRED_VERSION=`grep "#define MILDREDVERSION" src/version.h | sed "s/.*\"\(.*\)\"/\1/g"`
      # Fix icon link
      sed -i -e "s/Mildred.icns/Mildred.icns/g" Mildred-${MILDRED_VERSION}/Mildred.app/Contents/Info.plist
      # Create DMG
      dmgbuild -s ci/osx/dmgbuild-settings.py -D app=./Mildred-${MILDRED_VERSION}/Mildred.app -D icon=./Mildred-${MILDRED_VERSION}/Mildred.app/Contents/Resources/Mildred.icns "Mildred" Mildred-${MILDRED_VERSION}.dmg
    displayName: 'Create Disk Images'
  - bash: |
      set -ex
      mkdir packages
      mv Mildred*.dmg packages
    displayName: 'Move Artifacts'
